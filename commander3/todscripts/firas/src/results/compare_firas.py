"""
This script compares the current maps generated by this pipeline to the original FIRAS results.

Original FIRAS maps information:
HIGH
NU_ZERO =        612.187290000
DELTA_NU=        13.6041620000
NUM_FREQ=                  170
"""

import healpy as hp
import matplotlib.pyplot as plt
import numpy as np
from astropy.io import fits

import globals as g
import utils.my_utils as utils

original_path = "/mn/stornext/d16/cmbco/ola/firas/healpix_products/"
new_path = "/mn/stornext/u3/aimartin/d5/firas-reanalysis/Commander/commander3/todscripts/firas/output/fits_files/"
save_path = g.SAVE_PATH + "maps/results/"

frequencies = utils.generate_frequencies("ll", "ss")
data_lowf = fits.open(f"{original_path}firas_hpx_destriped_sky_spectra_lowf_v2.fits")
data_high = fits.open(f"{original_path}firas_hpx_destriped_sky_spectra_high_v2.fits")
for freqi, freq in enumerate(frequencies):
    spectrum = data_lowf[1].data["SPECTRUM"]

    lat = data_lowf[1].data["GAL_LAT"]
    lon = data_lowf[1].data["GAL_LON"]

    pix = hp.ang2pix(16, lon, lat, lonlat=True)
    weight = data_lowf[1].data["WEIGHT"]
    m = np.zeros(hp.nside2npix(16))
    for i in range(len(pix)):
        m[pix[i]] += spectrum[i, freqi] * weight[i]
    denom = np.bincount(pix, weights=weight, minlength=hp.nside2npix(16))
    mask = denom == 0
    m[~mask] /= denom[~mask]
    m[mask] = hp.UNSEEN
    monopole = utils.planck(freq, g.T_CMB)
    m -= monopole
    hp.mollview(m, title=f"FIRAS original")
    plt.savefig(f"{save_path}original_{int(freq):04d}.png")
    plt.close()
